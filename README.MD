# Комплексная задача «Бонусный сервер»

## Установка приложения

- Клонировать репозиторий

Последующие команды выполняются из корневой папки проекта (если не другого не указано)

*Примечание: далее предполагается, что на машине установлен composer, php7+ с расширением для драйвера pdo_sqlite и ngrok*

- Выполнить команду `composer install`. Должны установиться зависимости, появится папка `/vendor`
- Выполнить команду `vendor/bin/phinx migrate`. Должен создаться файл БД со структурой данных
- Из директории public/ выполнить команду `php -S localhost:xx` (где `xx` - номер свободного порта). Приложение будет доступно по адресу
  http://localhost:xx
- Выполнить команду `ngrok http xx` (где `xx` - номер порта из команды выше). Приложение будет доступно из большого интернета
- Выполнить команду `vendor/bin/phinx seed:run`. БД должна наполниться данными из bitrix24. Существующие контакты запишутся в БД и им будет начислен велком-бонус


## Легенда

Клиент — сеть продуктовых магазинов, запустили доставку продуктов через интернет. Заказы фиксируются в CRM Битрикс24 в направлении сделок
«доставка продуктов». Требуется реализовать бонусную программу для постоянных покупателей.

## Ожидаемая архитектура разрабатываемой системы

Общее описание взаимодействия систем на уровне сущностей и потоков данных необходимое для понимания бизнес-целей заказчика.

- в качестве интерфейса к заказам и клиентам используется Битрикс24.
- клиенты хранятся в CRM Б24 в сущности Контакты, заказы хранятся в сделках.
- табличная часть заказа имеет связь с продуктами.
- бонусные начисления применяются в виде монетарной скидки к табличной части сделки изменяя сумму сделки.
- как только контакт создаётся в Битрикс24, то ему назначается карта в приложении.
- бонусы начисляются при успешном закрытии сделки, если по ней не было произведено частичной оплаты.

### Стадии заказа в Битрикс24

Вся операционная деятельность связанная с обработкой заказов ведётся в направлении сделок `delivery`.

- `new_order` — все новые заказы создаются в этой стадии, на этой стадии начисляются, если есть велком-бонусы
- подтверждение заказа — на этой стадии менеджер связывается с клиентом и подтверждает заказ
- `bonus_payment` — специальная стадия, на которую переводится заказ в случае желания клиента сделать частичную оплату бонусами. С этой
  стадии в вашу систему будет вызов веб-хука. На этой стадии вы должны считать правила частичной оплаты (максимально разрешённый % оплаты) и
  обновить сделку применив к ней монетарную скидку, в вашей системе должно произойти списание бонусов.
- комплектация — тут заказ комплектуется
- передан курьеру — доставка заказа клиенту
- `order_delivered` (сделка выиграна) — на этой стадии заказ считается доставленным клиенту. С этой стадии в вашу систему будет вызов
  веб-хука. На этой стадии вы должны считать правила начисления (% начисления бонусов) и произвести начисление бонусов по заказу.
- `order_cancelled` (сделка проиграна)

**Внимание!**
Направление сделок ответственно за доставку - `delivery`

Стадии: `new_order`, `bonus_payment`,`order_delivered` и `order_cancelled` нужно называть именно так, они будут использоваться в служебных
скриптах генерации данных и автоматических проверках.

## Интервью с заказчиком

Заказчику были сформулированы и заданы [вопросы](documentation/interview_with_customer.MD). Из них можно собрать требования к
разрабатываемой системе.

## Порядок выполнения работ

Что нужно сделать для успешного выполнения задачи.

### Подготовка рабочего окружения — настройка Битрикс24

1. Сделать чекаут репозитория в своём рабочем окружении и периодически его обновлять
2. Зарегистрировать аккаунт в Битрикс24 и создать свой портал Битрикс24
3. Включить тестовый период на 1 месяц в настройках портала
4. Включить тестовый период на 1 месяц для приложений «по подписке»
5. Создать направление сделок «delivery»
6. Создать стадию сделок «bonus_payment»
7. Добавить CRM-робот «вебхук» на стадию «bonus_payment»
8. Зарегистрировать «ВХОДЯЩИЙ» вебхук в разделе «для разработчиков» с правами «CRM»
9. Поставить из маркетплейса приложение «документация по REST-API»

### Подготовка рабочего окружения — сервер приложения

1. Сделать публично-доступный хост в интернете с поддержкой https
2. Убедиться, что вебхуки от Битрикс24 доходят до этого хоста
3. Убедиться, что PHP позволяет делать запросы в ваш Б24 через REST-API используя ваш вебхук

### Разработка

Написать код, который реализует бизнес-требования заказчика

### Самостоятельное тестирование

1. написать тесты для проверки разработанного функционала
2. можно использовать генератор демо-данных по сделкам

### Автоматическое приёмочное тестирование

1. Изменить параметры подключения на свой портал для интеграционных тестов
2. Убедиться, что все тесты проходят и зелёные

### Подготовка презентации к защите

### Защита проекта

1. Сделать презентацию проекта не более 10 слайдов.
2. Отрепетировать рассказ по проекту длительностью 10 минут + 5 минут ответы на вопросы.
3. Защитить проект

## Критерии выполнения задачи

### Технические требования к проекту

1. Алгоритм применения скидки к заказу реализовать в виде отдельного класса и покрыть его юнит-тестами
2. Версия PHP - 7.4
3. Можно использовать сторонние библиотеки или компоненты, желательно из экосистемы фреймворка Symfony
4. Разработанная система удовлетворяет всем требованиям описанным в разделе «требования по проекту» которые сформулировал на основании
   интервью исполнитель.
5. Система проходит интеграционные тесты которые представляют собой набор заранее заготовленных тестовых данных: сделки с табличными частями
   до и после применения скидок, результаты начисления бонусов.
6. Статический анализатор кода [PHPStan](https://phpstan.org/user-guide/rule-levels) не показывает ошибок в вашем коде, уровень проверки - 6

## Информация для самостоятельного изучения

- REST-API по работе с Битрикс24 https://dev.1c-bitrix.ru/rest_help/

### Как хранятся цены и скидки в продуктовых строках в сделках Битрикс24

Для каждой продуктовой строки в сделке цена хранится в служебных полях:

- `PRICE` — цена (именно её видит клиент, к ней применены все скидки и налоги);
- `PRICE_ACCOUNT` — цена отформатированная для вывода в отчётах;
- `PRICE_BRUTTO` — цена с налогом, но без скидки;
- `PRICE_EXCLUSIVE` — цена без налога, но со скидкой;
- `PRICE_NETTO` — цена без налога и без скидки;

Скидка и её тип хранится в полях табличной части продукта:

- `DISCOUNT_TYPE_ID` — тип скидки, фиксированное число - 1, процент от сумы - 2
- `DISCOUNT_RATE` — процент скидки от стоимости одной единицы товарной позиции
- `DISCOUNT_SUM` — монетарная сумма скидки

## Консольные утилиты для работы с проектом

Перед началом работы укажите в файле `.env` параметры подключения к своему Битрикс24

## Настройка Битрикс24 для работы с предметной областью

Выполните команду по созданию пользовательских полей для сущностей

```shell
php bin/console install:predefined-userfields
```

### Служебные поля в сущностях

Служебные поля в сущностях Битрикс24 являются **проекцией** данных из базы учебного проекта и используются для удобства отладки и
тестирования.
Т.е. если у контакта в бонусном сервисе который делает студент изменяется баланс, то нужно вызвать соответствующий метод и изменить баланс в
пользовательском поле у контакта в Битрикс24.

#### Контакты

- `BonusBalance` Сумма бонусов на балансе у контакта. Хранит текущую сумму бонусов у контакта.

Работа с полями идёт через класс `Rarus\Interns\BonusServer\TrainingClassroom\Services\PredefinedUserFields\DealFields`

#### Сделки

- `PayWithBonuses` Сумма к оплате бонусами. Хранит сумму, которую требуется списать в счёт частичной оплаты.
- `DebitedBonuses` Сумма, которая была списана. Хранит сумму, которая была списана в счёт частичной оплаты.
- `AccruedBonuses` Сумма начисленных за успешную сделку (заказ) бонусов. Хранит сумму, которая была начислена.

Работа с полями идёт через класс `Rarus\Interns\BonusServer\TrainingClassroom\Services\PredefinedUserFields\DealFields`

### Генерация тестовых контактов

Пример вызова

```
mesilov@mesilov-local bonus-server % php bin/console generate:contacts --count=3 
Генерация контактов в Битрикс24
===============================
домен для подключения: https://b24-ze7zs7.bitrix24.ru/rest/1/h7qqqzeetysfsl16/
количество контактов: 3

Добавляем контакты…
-------------------

1 | contact id: 3654
2 | contact id: 3656
3 | contact id: 3658
batch query duration: 0.5 seconds
                                                                                                                       
 [OK] контакты успешно добавлены                                                                                        

mesilov@mesilov-local bonus-server % 
```

### Генерация тестовых товаров

Пример вызова

```
mesilov@mesilov-local bonus-server % php bin/console generate:products --count=3 
Генерация контактов в Битрикс24
===============================
домен для подключения: https://b24-ze7zs7.bitrix24.ru/rest/1/h7qqqzeetysfsl16/
количество продуктов: 3

Добавляем продукты…
-------------------

1 | product id: 3654
2 | product id: 3656
3 | product id: 3658
batch query duration: 0.5 seconds
                                                                                                                       
 [OK] продукты успешно добавлены                                                                                        

mesilov@mesilov-local bonus-server % 
```

### Генерация тестовых сделок с табличной частью

не реализовано

## Окружение разработчика

### Symfony Local Web Server + ngrok

1. Ставим [Symfony Local Web Server](https://symfony.com/doc/current/setup/symfony_server.html)
2. Регистрируемся в [ngrok](https://ngrok.com/)
3. Запускаем локальный сервер

```
symfony server:start 
```

ожидаемый вид в консоли:

```
mesilov@mesilov-local bonus-server % symfony server:start 
Tailing Web Server log file (/Users/mesilov/.symfony/log/927571b35aeab65621b9252ae3bf591bd2158ebc.log)
Tailing PHP-FPM log file (/Users/mesilov/.symfony/log/927571b35aeab65621b9252ae3bf591bd2158ebc/53fb8ec204547646acb3461995e4da5a54cc7575.log)
                                                                                                                        
 [OK] Web server listening                                                                                              
      The Web server is using PHP FPM 7.4.2                                                                             
      https://127.0.0.1:8001                                                                                            
                                                                                                                        

[Web Server ] Dec 11 10:48:34 |INFO   | PHP    listening path="/usr/local/Cellar/php/7.4.2/sbin/php-fpm" php="7.4.2" port=53487
[PHP-FPM    ] Dec 11 10:48:34 |NOTICE | FPM    fpm is running, pid 13792 
[PHP-FPM    ] Dec 11 10:48:34 |NOTICE | FPM    ready to handle connections 
[Web Server ] Dec 11 10:49:00 |INFO   | SERVER GET  (200) / ip="127.0.0.1"
[Web Server ] Dec 11 10:49:33 |INFO   | SERVER GET  (200) /?qqq=111 
[Web Server ] Dec 11 10:57:18 |INFO   | SERVER GET  (200) / 
[Web Server ] Dec 11 10:57:18 |INFO   | SERVER GET  (200) /favicon.ico 
[Web Server ] Dec 11 11:00:56 |INFO   | SERVER GET  (200) /?qqq=111 
```

4. Убеждаемся, что файл index.php открывается из браузера и вы видите запрос в логах и браузере
5. Стартуем ngrok с указанием того адреса, на котором запущен локальный веб-сервер

```
./ngrok http https://127.0.0.1:8001
```

ожидаемый вид в консоли:

```
ngrok by @inconshreveable                                                                                                                                                                     (Ctrl+C to quit)
                                                                                                                                                                                                              
Session Status                online                                                                                                                                                                          
Account                       Maxim (Plan: Free)                                                                                                                                                              
Version                       2.3.35                                                                                                                                                                          
Region                        United States (us)                                                                                                                                                              
Web Interface                 http://127.0.0.1:4040                                                                                                                                                           
Forwarding                    http://d56e04bf0ef3.ngrok.io -> https://127.0.0.1:8001                                                                                                                          
Forwarding                    https://d56e04bf0ef3.ngrok.io -> https://127.0.0.1:8001                                                                                                                         
                                                                                                                                                                                                              
Connections                   ttl     opn     rt1     rt5     p50     p90                                                                                                                                     
                              1       2       0.00    0.00    300.86  300.86  
```

6. Пробуем открыть адрес `https://d56e04bf0ef3.ngrok.io` (**у вас он будет другой**) и видим тот же запрос. Если нужна доп.информация, то
   можно посмотреть через веб-интерфейс ngrok
   

